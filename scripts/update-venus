#!/bin/bash
DATE=$(date +%F)
LOG_DATE=$(date +%F-%R)
BASE_DIR="/var/www/planet.gentoo.org/"
RESTRICT=""
VENUS_DIR="/usr/lib/python2.6/site-packages/venus/"

# Create folders and symlinks (for initial setup)
mkdir -p ${BASE_DIR}htdocs
[[ -L ${BASE_DIR}public_html ]] || ln -s ${BASE_DIR}htdocs ${BASE_DIR}public_html
if [ ! -d ${BASE_DIR}planet-gentoo]; then 
        git clone git://git.overlays.gentoo.org/proj/planet-gentoo.git ${BASE_DIR}planet-gentoo
fi
mkdir -p ${BASE_DIR}logs/{planet,universe} ${BASE_DIR}generated_configs
touch generated_configs/venus.{planet,universe}.ini
[[ -L ${BASE_DIR}htdocs/images ]] ln -s ${BASE_DIR}planet-gentoo/media/* htdocs/
mkdir -p ${BASE_DIR}htdocs/archives ${BASE_DIR}htdocs/universe/archives

# Get latest Git changes
git pull ${BASE_DIR}planet-gentoo/ >/dev/null 2>&1

# Run Venus
for x in planet universe; do
        if [[ ! -z $RESTRICT ]]; then
                for y in $RESTRICT; do
                        rm ${BASE_DIR}planet-gentoo/configs/${x}/${y}
                done
        fi
        cat ${BASE_DIR}planet-gentoo/configs/base/venus.${x} ${BASE_DIR}planet-gentoo/configs/${x}/* > ${BASE_DIR}generated_configs/venus.${x}.ini
        python ${VENUS_DIR}planet.py ${BASE_DIR}generated_configs/venus.${x}.ini > ${BASE_DIR}logs/${x}/${LOG_DATE}.log 2>&1
done

# Delete old logs
find ${BASE_DIR}logs -type f -mtime +30 -delete

# Archive posts
cp ${BASE_DIR}htdocs/index.html \
        ${BASE_DIR}htdocs/archives/${DATE}.html
cp ${BASE_DIR}htdocs/universe/index.html \
        ${BASE_DIR}htdocs/universe/archives/${DATE}.html

